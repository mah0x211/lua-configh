# lua-configh

[![test](https://github.com/mah0x211/lua-configh/actions/workflows/test.yml/badge.svg)](https://github.com/mah0x211/lua-configh/actions/workflows/test.yml)
[![codecov](https://codecov.io/gh/mah0x211/lua-configh/branch/master/graph/badge.svg)](https://codecov.io/gh/mah0x211/lua-configh)


lua-configh is a helper module that generates config.h file.


## Installation

```
luarocks install configh
```


## Usage


```lua
local configh = require('configh')
-- create configh object
local cfgh = configh('gcc')

-- set feature macro
cfgh:set_feature('_GNU_SOURCE')

-- add cppflags
-- CPPFLAGS environment variable is also loaded automatically
cfgh:add_cppflag('-I/usr/local/include')

-- check whether the specified header file exists or not.
local ok, err = cfgh:check_header('stdio.h')
if not ok then
    print('stdio.h not found')
    print(err)
    return
end

-- check whether the specified header file exists or not.
cfgh:check_header('unknown_header_file.h')

-- check whether the specified function exists or not.
ok, err = cfgh:check_func('stdio.h', 'printf')
if not ok then
    print('printf not found')
    print(err)
    return
end

-- flush the definition macros to the specified pathname.
ok, err = cfgh:flush('./config.h')
if not ok then
    print('failed to write config.h')
    print(err)
    return
end

-- config.h
local f = assert(io.open('./config.h', 'r'))
print(f:read('*a'))
f:close()

-- above code outputs the following:
--[[
/**
 * this file is generated by lua-configh module at Sat Jun 17 12:57:53 2023
 */

/* Define to 1 if you have the <stdio.h> header file. */
#define HAVE_STDIO_H 1

/* Define to 1 if you have the <unknown_header_file.h> header file. */
/* #undef HAVE_UNKNOWN_HEADER_FILE_H */

/* Define to 1 if you have the `printf' function. */
#define HAVE_PRINTF 1

]]
```

---

## cfgh = configh( cc )

creates a `configh` object.

**Parameters**

- `cc:string`: a C compiler name. (`gcc`, `clang`, etc..)

**Returns**

- `cfgh:configh`: `configh` object.


## configh:set_feature( name [, value] )

defines a feature macro in generated source code.

**Parameters**

- `name:string`: a feature macro name.
- `value:string|number?`: a feature macro value.


## configh:unset_feature( name )

remove a feature macro that set by `configh:set_feature` method.

**Parameters**

- `name:string`: a feature macro name.


## configh:add_cppflag( flag )

add a cppflag to be used when compiling test code.

**Parameters**

- `flag:string`: a cppflag string (e.g. `-I/usr/local/include`, `-DDEBUG`).

**NOTE**

- The `CPPFLAGS` environment variable is automatically loaded when creating a `configh` object.
- Tilde (`~`) is **not** expanded. Use `$HOME` or absolute path instead (e.g. `-I$HOME/include` or `-I/home/user/include`).


## configh:remove_cppflag( flag )

remove a cppflag that was added by `configh:add_cppflag` method.

**Parameters**

- `flag:string`: a cppflag string.


## configh:output_status( enabled )

enables or disables the output of status messages to stdout when the `configh:check_header`, `configh:check_func`, `configh:check_type`, `configh:check_decl`, `configh:check_member` methods are called.

**Parameters**

- `enabled:boolean`: `true` to enable, or `false` to disable.


## configh:set_stdout( [outfile] )

sets the output file for status messages when the `configh:check_header`, `configh:check_func`, `configh:check_type`, `configh:check_decl`, `configh:check_member` methods are called.

**Parameters**

- `outfile:file*?`: an output file handle. If `nil` or omitted, `io.stdout` is used.


## ok, err = configh:check_header( header )

checks whether the specified header file exists or not.

**Parameters**

- `header:string`: a header file name.

**Returns**

- `ok:boolean`: `true` on success, or `false` on failure.
- `err:string`: error message if the generated source code fails to compile.


## ok, err = configh:check_func( headers, func )

checks whether the specified function exists or not.

**Parameters**

- `headers:string|string[]`: a header file name or array of header file names.
- `func:string`: a function name.

**Returns**

- `ok:boolean`: `true` on success, or `false` on failure.
- `err:string`: error message if the generated source code fails to compile.


## ok, err = configh:check_type( headers, type )

checks whether the specified type exists or not.

**Parameters**

- `headers:string|string[]`: a header file name or array of header file names.
- `type:string`: a type name.

**Returns**

- `ok:boolean`: `true` on success, or `false` on failure.
- `err:string`: error message if the generated source code fails to compile.


## ok, err = configh:check_decl( headers, name )

checks whether the specified declaration (macro constant, enum value, or global variable) exists or not.

**Parameters**

- `headers:string|string[]`: a header file name or array of header file names.
- `name:string`: a declaration name.

**Returns**

- `ok:boolean`: `true` on success, or `false` on failure.
- `err:string`: error message if the generated source code fails to compile.


## ok, err = configh:check_member( headers, type, member )

checks whether the specified member field exists in the type or not.

**Parameters**

- `headers:string|string[]`: a header file name or array of header file names.
- `type:string`: a type name.
- `member:string`: a member name.

**Returns**

- `ok:boolean`: `true` on success, or `false` on failure.
- `err:string`: error message if the generated source code fails to compile.


## ok, err = configh:flush( pathname )

flushes the definition macros to the specified pathname.

**Parameters**

- `pathname:string`: a pathname of config.h file.

**Returns**

- `ok:boolean`: `true` on success, or `false` on failure.
- `err:string`: error message if the definition macro failed to be written.

